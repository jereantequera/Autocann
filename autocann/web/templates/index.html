<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autocann - Control Room</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0f0d;
            --bg-secondary: #111916;
            --bg-card: #151d19;
            --bg-card-hover: #1a2420;
            --border-color: #243028;
            --border-accent: #2d4035;
            
            --text-primary: #e8f0eb;
            --text-secondary: #8fa396;
            --text-muted: #5a6b5f;
            
            --accent-green: #22c55e;
            --accent-green-dim: #166534;
            --accent-lime: #84cc16;
            --accent-emerald: #10b981;
            --accent-teal: #14b8a6;
            
            --temp-hot: #f97316;
            --temp-warm: #fbbf24;
            --temp-cool: #38bdf8;
            
            --humidity-high: #3b82f6;
            --humidity-low: #f472b6;
            
            --vpd-optimal: #22c55e;
            --vpd-adjusting: #f59e0b;
            --vpd-danger: #ef4444;
            
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 20px rgba(0,0,0,0.4);
            --shadow-lg: 0 8px 40px rgba(0,0,0,0.5);
            --shadow-glow: 0 0 30px rgba(34, 197, 94, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border-color);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-emerald));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: var(--shadow-glow);
        }

        .logo h1 {
            font-size: 1.8em;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .logo h1 span {
            color: var(--accent-green);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-card);
            border-radius: 8px;
            font-size: 0.85em;
            border: 1px solid var(--border-color);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-green);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .last-update {
            color: var(--text-secondary);
            font-size: 0.85em;
        }

        /* Sensor Alert */
        .sensor-alert {
            background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%);
            padding: 16px 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            display: none;
            align-items: center;
            gap: 16px;
            border: 1px solid #dc2626;
            animation: alert-pulse 2s ease-in-out infinite;
        }

        @keyframes alert-pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(239, 68, 68, 0.2); }
            50% { box-shadow: 0 0 30px rgba(239, 68, 68, 0.4); }
        }

        .sensor-alert-icon { font-size: 2em; }
        .sensor-alert-content { flex: 1; }
        .sensor-alert-title { font-weight: 600; font-size: 1.1em; margin-bottom: 4px; }
        .sensor-alert-message { opacity: 0.9; font-size: 0.95em; }

        /* Grow Control Bar */
        .grow-bar {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px 24px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .grow-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .grow-name {
            font-size: 1.2em;
            font-weight: 600;
        }

        .grow-stage {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .grow-stage.early_veg { background: rgba(34, 197, 94, 0.2); color: var(--accent-green); }
        .grow-stage.late_veg { background: rgba(132, 204, 22, 0.2); color: var(--accent-lime); }
        .grow-stage.flowering { background: rgba(244, 114, 182, 0.2); color: #f472b6; }
        .grow-stage.dry { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }

        .grow-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--accent-green);
            color: var(--bg-primary);
        }

        .btn-primary:hover {
            background: var(--accent-emerald);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-accent);
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .btn-ghost:hover {
            color: var(--text-primary);
            border-color: var(--accent-green);
        }

        /* Main Grid Layout */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 30px;
        }

        /* Hero Grid - 4 columns */
        .hero-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 1200px) {
            .hero-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .hero-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Hero Cards - VPD and Temperature */
        .hero-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 28px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .hero-card:hover {
            border-color: var(--border-accent);
            box-shadow: var(--shadow-md);
        }

        .hero-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-green), var(--accent-emerald));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .hero-card:hover::before {
            opacity: 1;
        }

        .hero-card.vpd-optimal {
            border-color: var(--accent-green);
            box-shadow: var(--shadow-glow);
        }

        .hero-card.vpd-optimal::before {
            opacity: 1;
        }

        .hero-card.vpd-adjusting {
            border-color: var(--vpd-adjusting);
        }

        .hero-card.vpd-adjusting::before {
            background: linear-gradient(90deg, var(--vpd-adjusting), var(--temp-warm));
            opacity: 1;
        }

        .hero-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .hero-label {
            color: var(--text-secondary);
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
        }

        .sensor-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75em;
            font-weight: 500;
        }

        .sensor-badge.ok {
            background: rgba(34, 197, 94, 0.2);
            color: var(--accent-green);
        }

        .sensor-badge.error {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .hero-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 3.2em;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 8px;
            letter-spacing: -2px;
        }

        @media (min-width: 1400px) {
            .hero-value {
                font-size: 3.8em;
            }
        }

        .hero-unit {
            color: var(--text-muted);
            font-size: 0.4em;
            font-weight: 400;
            letter-spacing: 0;
            margin-left: 4px;
        }

        .hero-subtitle {
            color: var(--text-secondary);
            font-size: 1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* VPD Status Badge */
        .vpd-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .vpd-badge.in-range {
            background: rgba(34, 197, 94, 0.2);
            color: var(--accent-green);
        }

        .vpd-badge.adjusting {
            background: rgba(245, 158, 11, 0.2);
            color: var(--vpd-adjusting);
        }

        /* VPD Gauge */
        .vpd-gauge {
            margin-top: 20px;
            position: relative;
        }

        .vpd-gauge-bar {
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            position: relative;
            overflow: visible;
        }

        .vpd-gauge-zones {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            border-radius: 4px;
            overflow: hidden;
        }

        .vpd-zone {
            height: 100%;
        }

        .vpd-zone.low { background: var(--humidity-high); flex: 0.6; }
        .vpd-zone.optimal { background: var(--vpd-optimal); flex: 0.9; }
        .vpd-zone.high { background: var(--vpd-danger); flex: 0.5; }

        .vpd-gauge-marker {
            position: absolute;
            top: -4px;
            width: 4px;
            height: 16px;
            background: var(--text-primary);
            border-radius: 2px;
            transform: translateX(-50%);
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
            transition: left 0.5s ease;
        }

        .vpd-gauge-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.75em;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        /* Hero Card Variants */
        .hero-card.hero-vpd {
            grid-column: span 1;
        }

        .hero-card.hero-temp .hero-value {
            color: var(--temp-hot);
        }

        .hero-card.hero-humidity .hero-value {
            color: var(--humidity-high);
        }

        .hero-card.hero-target .hero-value {
            color: var(--accent-green);
        }

        .hero-card.hero-target {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(34, 197, 94, 0.08) 100%);
            border-color: var(--accent-green-dim);
        }

        /* Humidity Bar */
        .humidity-bar-container {
            margin-top: 16px;
        }

        .humidity-bar {
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            position: relative;
            overflow: visible;
        }

        .humidity-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--humidity-high), var(--accent-teal));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .humidity-bar-target {
            position: absolute;
            top: -4px;
            width: 4px;
            height: 16px;
            background: var(--accent-green);
            border-radius: 2px;
            transform: translateX(-50%);
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
            transition: left 0.5s ease;
        }

        .humidity-bar-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.75em;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        /* Humidity Difference Indicator */
        .humidity-diff {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .humidity-diff.on-target {
            background: rgba(34, 197, 94, 0.2);
            color: var(--accent-green);
        }

        .humidity-diff.too-low {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .humidity-diff.too-high {
            background: rgba(59, 130, 246, 0.2);
            color: var(--humidity-high);
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
        }

        .metric-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s ease;
        }

        .metric-card:hover {
            border-color: var(--border-accent);
        }

        .metric-label {
            color: var(--text-secondary);
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .metric-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2em;
            font-weight: 600;
            line-height: 1.2;
        }

        .metric-unit {
            color: var(--text-muted);
            font-size: 0.5em;
            font-weight: 400;
            margin-left: 2px;
        }

        /* Section Headers */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 30px 0 20px 0;
        }

        .section-title {
            font-size: 1.3em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title-icon {
            width: 32px;
            height: 32px;
            background: var(--bg-card);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        /* Summary Stats */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
        }

        .summary-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .summary-card-title {
            font-size: 1em;
            font-weight: 500;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .summary-card-title .icon {
            font-size: 1.2em;
        }

        .summary-avg {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2.5em;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 16px;
        }

        .summary-minmax {
            display: flex;
            gap: 24px;
        }

        .summary-stat {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .summary-stat-label {
            font-size: 0.75em;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.2em;
            font-weight: 500;
        }

        .summary-stat-value.min { color: var(--temp-cool); }
        .summary-stat-value.max { color: var(--temp-hot); }

        /* Outdoor Section */
        .outdoor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .outdoor-card {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(20, 184, 166, 0.1) 100%);
            border: 1px solid var(--accent-teal);
            border-radius: 12px;
            padding: 20px;
        }

        .outdoor-card .metric-label {
            color: var(--accent-teal);
        }

        /* Outputs Section */
        .outputs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .output-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
        }

        .output-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .output-name {
            font-weight: 500;
            font-size: 1em;
        }

        .output-pin {
            font-size: 0.75em;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        .output-state {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.3em;
            font-weight: 600;
        }

        .output-state.on { color: var(--accent-green); }
        .output-state.off { color: var(--vpd-danger); }
        .output-state.unknown { color: var(--text-muted); }

        /* Charts Section */
        .charts-section {
            margin-top: 30px;
        }

        .chart-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .chart-title {
            font-size: 1.2em;
            font-weight: 600;
        }

        .time-selector {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            background: var(--bg-secondary);
            padding: 4px;
            border-radius: 10px;
        }

        .time-btn {
            padding: 8px 14px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            font-family: inherit;
            font-size: 0.85em;
        }

        .time-btn:hover {
            color: var(--text-primary);
            background: var(--bg-card);
        }

        .time-btn.active {
            background: var(--accent-green);
            color: var(--bg-primary);
        }

        .chart-wrapper {
            position: relative;
            height: 350px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(8px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            padding: 32px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            color: var(--text-primary);
            font-family: inherit;
            transition: border-color 0.2s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent-green);
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 28px;
        }

        .grow-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .grow-item {
            padding: 16px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .grow-item:hover {
            border-color: var(--accent-green);
            background: var(--bg-card-hover);
        }

        .grow-item.active {
            border-color: var(--accent-green);
            background: rgba(34, 197, 94, 0.1);
        }

        .grow-item-name {
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 8px;
        }

        .grow-item-date {
            font-size: 0.85em;
            color: var(--text-muted);
            margin-top: 8px;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }

            .header-right {
                flex-direction: column;
            }

            .grow-bar {
                flex-direction: column;
                text-align: center;
            }

            .hero-value {
                font-size: 2.5em;
                letter-spacing: -1px;
            }

            .hero-grid {
                grid-template-columns: 1fr 1fr;
                gap: 12px;
            }

            .hero-card {
                padding: 20px;
            }

            .chart-wrapper {
                height: 280px;
            }

            .summary-avg {
                font-size: 2em;
            }
        }

        @media (max-width: 480px) {
            .hero-grid {
                grid-template-columns: 1fr;
            }

            .hero-value {
                font-size: 3em;
            }
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .loading::after {
            content: '...';
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-accent);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-green-dim);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">üåø</div>
                <h1>Auto<span>cann</span></h1>
            </div>
            <div class="header-right">
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span>Sistema Activo</span>
                </div>
                <div class="last-update" id="last-update">Cargando...</div>
            </div>
        </header>

        <!-- Sensor Alert -->
        <div id="sensor-alert" class="sensor-alert">
            <div class="sensor-alert-icon">‚ö†Ô∏è</div>
            <div class="sensor-alert-content">
                <div class="sensor-alert-title">Problema con sensores</div>
                <div class="sensor-alert-message" id="sensor-alert-message">--</div>
            </div>
        </div>

        <!-- Grow Control Bar -->
        <div class="grow-bar">
            <div class="grow-info">
                <span class="grow-name" id="grow-name">Cargando...</span>
                <span class="grow-stage" id="grow-stage">--</span>
            </div>
            <div class="grow-actions">
                <button class="btn btn-ghost" onclick="showGrowModal()">üìã Cultivos</button>
                <button class="btn btn-secondary" onclick="showStageModal()">üîÑ Etapa</button>
                <button class="btn btn-primary" onclick="showNewGrowModal()">‚ûï Nuevo</button>
            </div>
        </div>

        <!-- Hero Section - Main Metrics -->
        <div class="hero-grid">
            <!-- VPD Card -->
            <div class="hero-card hero-vpd" id="vpd-card">
                <div class="hero-header">
                    <div class="hero-label">üéØ VPD Interior</div>
                    <span class="sensor-badge" id="sensor-status-indoor">‚è≥</span>
                </div>
                <div class="hero-value" id="current-vpd">--<span class="hero-unit">kPa</span></div>
                <div class="hero-subtitle">
                    <span class="vpd-badge" id="vpd-status"></span>
                    <span id="vpd-target-hint"></span>
                </div>
                <div class="vpd-gauge">
                    <div class="vpd-gauge-bar">
                        <div class="vpd-gauge-zones">
                            <div class="vpd-zone low"></div>
                            <div class="vpd-zone optimal"></div>
                            <div class="vpd-zone high"></div>
                        </div>
                        <div class="vpd-gauge-marker" id="vpd-marker" style="left: 50%"></div>
                    </div>
                    <div class="vpd-gauge-labels">
                        <span>0.0</span>
                        <span>0.6</span>
                        <span>1.5</span>
                        <span>2.0</span>
                    </div>
                </div>
            </div>

            <!-- Temperature Card -->
            <div class="hero-card hero-temp">
                <div class="hero-header">
                    <div class="hero-label">üå°Ô∏è Temperatura</div>
                </div>
                <div class="hero-value temp-value" id="current-temp">--<span class="hero-unit">¬∞C</span></div>
                <div class="hero-subtitle">
                    <span style="color: var(--text-muted);">Temp. Hoja:</span>
                    <strong id="current-leaf-temp">--</strong>¬∞C
                </div>
            </div>

            <!-- Humidity Card -->
            <div class="hero-card hero-humidity">
                <div class="hero-header">
                    <div class="hero-label">üíß Humedad Actual</div>
                </div>
                <div class="hero-value humidity-value" id="current-humidity">--<span class="hero-unit">%</span></div>
                <div class="humidity-bar-container">
                    <div class="humidity-bar">
                        <div class="humidity-bar-fill" id="humidity-bar-fill" style="width: 0%"></div>
                        <div class="humidity-bar-target" id="humidity-bar-target" style="left: 50%"></div>
                    </div>
                    <div class="humidity-bar-labels">
                        <span>0%</span>
                        <span>50%</span>
                        <span>100%</span>
                    </div>
                </div>
            </div>

            <!-- Target Humidity Card -->
            <div class="hero-card hero-target">
                <div class="hero-header">
                    <div class="hero-label">üéØ Humedad Objetivo</div>
                </div>
                <div class="hero-value target-value" id="current-target-humidity">--<span class="hero-unit">%</span></div>
                <div class="hero-subtitle">
                    <span class="humidity-diff" id="humidity-diff"></span>
                </div>
            </div>
        </div>

        <!-- Period Summary -->
        <div class="section-header">
            <h2 class="section-title">
                <span class="section-title-icon">üìä</span>
                Resumen del Per√≠odo
            </h2>
            <div class="time-selector" id="time-selector-top">
                <button class="time-btn" data-hours="1" data-interval="raw">1h</button>
                <button class="time-btn" data-hours="2" data-interval="raw">2h</button>
                <button class="time-btn" data-hours="4" data-interval="raw">4h</button>
                <button class="time-btn" data-hours="8" data-interval="raw">8h</button>
                <button class="time-btn" data-hours="12" data-interval="raw">12h</button>
                <button class="time-btn active" data-period="1" data-interval="hourly">1d</button>
                <button class="time-btn" data-period="3" data-interval="hourly">3d</button>
                <button class="time-btn" data-period="7" data-interval="hourly">7d</button>
                <button class="time-btn" data-period="30" data-interval="6hourly">30d</button>
            </div>
        </div>
        <div class="summary-grid">
            <div class="summary-card">
                <div class="summary-card-header">
                    <div class="summary-card-title">
                        <span class="icon">üå°Ô∏è</span>
                        Temperatura Interior
                    </div>
                </div>
                <div class="summary-avg" id="summary-temp-avg">--<span class="hero-unit">¬∞C</span></div>
                <div class="summary-minmax">
                    <div class="summary-stat">
                        <span class="summary-stat-label">M√≠nima</span>
                        <span class="summary-stat-value min" id="summary-temp-min">--¬∞C</span>
                    </div>
                    <div class="summary-stat">
                        <span class="summary-stat-label">M√°xima</span>
                        <span class="summary-stat-value max" id="summary-temp-max">--¬∞C</span>
                    </div>
                    <div class="summary-stat">
                        <span class="summary-stat-label">Muestras</span>
                        <span class="summary-stat-value" id="summary-samples" style="color: var(--text-secondary);">--</span>
                    </div>
                </div>
            </div>
            <div class="summary-card">
                <div class="summary-card-header">
                    <div class="summary-card-title">
                        <span class="icon">üíß</span>
                        Humedad Interior
                    </div>
                </div>
                <div class="summary-avg" id="summary-humidity-avg">--<span class="hero-unit">%</span></div>
                <div class="summary-minmax">
                    <div class="summary-stat">
                        <span class="summary-stat-label">M√≠nima</span>
                        <span class="summary-stat-value min" id="summary-humidity-min">--%</span>
                    </div>
                    <div class="summary-stat">
                        <span class="summary-stat-label">M√°xima</span>
                        <span class="summary-stat-value max" id="summary-humidity-max">--%</span>
                    </div>
                </div>
            </div>
            <div class="summary-card">
                <div class="summary-card-header">
                    <div class="summary-card-title">
                        <span class="icon">üéØ</span>
                        VPD Promedio
                    </div>
                </div>
                <div class="summary-avg" id="summary-vpd-avg">--<span class="hero-unit">kPa</span></div>
                <div class="summary-minmax">
                    <div class="summary-stat">
                        <span class="summary-stat-label">M√≠nimo</span>
                        <span class="summary-stat-value min" id="summary-vpd-min">-- kPa</span>
                    </div>
                    <div class="summary-stat">
                        <span class="summary-stat-label">M√°ximo</span>
                        <span class="summary-stat-value max" id="summary-vpd-max">-- kPa</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Outdoor Section -->
        <div class="section-header">
            <h2 class="section-title">
                <span class="section-title-icon">üå§Ô∏è</span>
                Exterior
            </h2>
            <span class="sensor-badge" id="sensor-status-outdoor">‚è≥</span>
        </div>
        <div class="outdoor-grid">
            <div class="outdoor-card">
                <div class="metric-label">Temperatura</div>
                <div class="metric-value" id="current-outdoor-temp">--<span class="metric-unit">¬∞C</span></div>
            </div>
            <div class="outdoor-card">
                <div class="metric-label">Humedad</div>
                <div class="metric-value" id="current-outdoor-humidity">--<span class="metric-unit">%</span></div>
            </div>
            <div class="summary-card" style="background: linear-gradient(135deg, var(--bg-card) 0%, rgba(20, 184, 166, 0.05) 100%);">
                <div class="summary-card-title" style="margin-bottom: 12px;">
                    <span class="icon">üìà</span>
                    Exterior - Promedio del Per√≠odo
                </div>
                <div class="summary-minmax">
                    <div class="summary-stat">
                        <span class="summary-stat-label">Temp. Prom.</span>
                        <span class="summary-stat-value" id="summary-outside-temp" style="color: var(--accent-teal);">--¬∞C</span>
                    </div>
                    <div class="summary-stat">
                        <span class="summary-stat-label">Hum. Prom.</span>
                        <span class="summary-stat-value" id="summary-outside-humidity" style="color: var(--accent-teal);">--%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Outputs Section -->
        <div class="section-header">
            <h2 class="section-title">
                <span class="section-title-icon">üîå</span>
                Salidas (Relays)
            </h2>
        </div>
        <div class="outputs-grid" id="outputs-grid">
            <div class="output-card">
                <div class="output-name">Cargando...</div>
                <div class="output-state unknown">--</div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section">
            <div class="section-header">
                <h2 class="section-title">
                    <span class="section-title-icon">üìà</span>
                    Gr√°ficos Hist√≥ricos
                </h2>
                <div class="time-selector" id="time-selector-bottom">
                    <button class="time-btn" data-hours="1" data-interval="raw">1h</button>
                    <button class="time-btn" data-hours="2" data-interval="raw">2h</button>
                    <button class="time-btn" data-hours="4" data-interval="raw">4h</button>
                    <button class="time-btn" data-hours="8" data-interval="raw">8h</button>
                    <button class="time-btn" data-hours="12" data-interval="raw">12h</button>
                    <button class="time-btn active" data-period="1" data-interval="hourly">1d</button>
                    <button class="time-btn" data-period="3" data-interval="hourly">3d</button>
                    <button class="time-btn" data-period="7" data-interval="hourly">7d</button>
                    <button class="time-btn" data-period="30" data-interval="6hourly">30d</button>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">üå°Ô∏è Temperatura y Humedad Interior</div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="tempHumidityChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">üéØ VPD (Vapor Pressure Deficit)</div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="vpdChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">üîÑ Interior vs Exterior</div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="comparisonChart"></canvas>
                </div>
            </div>
        </div>

        <!-- DB Stats Footer -->
        <div style="margin-top: 40px; padding: 20px; background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-color);">
            <div style="display: flex; gap: 32px; flex-wrap: wrap; justify-content: center;">
                <div style="text-align: center;">
                    <div style="color: var(--text-muted); font-size: 0.8em; text-transform: uppercase; letter-spacing: 0.5px;">Registros</div>
                    <div style="font-family: 'JetBrains Mono', monospace; font-size: 1.3em; font-weight: 600;" id="stat-records">--</div>
                </div>
                <div style="text-align: center;">
                    <div style="color: var(--text-muted); font-size: 0.8em; text-transform: uppercase; letter-spacing: 0.5px;">Base de Datos</div>
                    <div style="font-family: 'JetBrains Mono', monospace; font-size: 1.3em; font-weight: 600;" id="stat-db-size">--</div>
                </div>
                <div style="text-align: center;">
                    <div style="color: var(--text-muted); font-size: 0.8em; text-transform: uppercase; letter-spacing: 0.5px;">Cultivos</div>
                    <div style="font-family: 'JetBrains Mono', monospace; font-size: 1.3em; font-weight: 600;" id="stat-grows">--</div>
                </div>
                <div style="text-align: center;">
                    <div style="color: var(--text-muted); font-size: 0.8em; text-transform: uppercase; letter-spacing: 0.5px;">Desde</div>
                    <div style="font-family: 'JetBrains Mono', monospace; font-size: 1.3em; font-weight: 600;" id="stat-oldest">--</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="newGrowModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Crear Nuevo Cultivo</div>
            <div class="form-group">
                <label class="form-label">Nombre del Cultivo</label>
                <input type="text" id="newGrowName" class="form-control" placeholder="Ej: Cultivo #2 - OG Kush">
            </div>
            <div class="form-group">
                <label class="form-label">Etapa Inicial</label>
                <select id="newGrowStage" class="form-control">
                    <option value="early_veg">Vegetativo Temprano</option>
                    <option value="late_veg">Vegetativo Tard√≠o</option>
                    <option value="flowering">Floraci√≥n</option>
                    <option value="dry">Secado</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Notas (opcional)</label>
                <textarea id="newGrowNotes" class="form-control" placeholder="Ej: Semillas feminizadas..."></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeModal('newGrowModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="createGrow()">Crear Cultivo</button>
            </div>
        </div>
    </div>

    <div id="stageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Cambiar Etapa</div>
            <div class="form-group">
                <label class="form-label">Nueva Etapa</label>
                <select id="newStage" class="form-control">
                    <option value="early_veg">Vegetativo Temprano</option>
                    <option value="late_veg">Vegetativo Tard√≠o</option>
                    <option value="flowering">Floraci√≥n</option>
                    <option value="dry">Secado</option>
                </select>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeModal('stageModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="updateStage()">Actualizar</button>
            </div>
        </div>
    </div>

    <div id="growsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Todos los Cultivos</div>
            <div class="grow-list" id="growList">
                <div class="loading">Cargando cultivos...</div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeModal('growsModal')">Cerrar</button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentPeriod = 1;
        let currentInterval = 'hourly';
        let currentHours = null;
        let currentStage = 'early_veg';
        let tempHumidityChart, vpdChart, comparisonChart;

        // VPD ranges per stage
        const VPD_RANGES = {
            early_veg: { min: 0.6, max: 1.0 },
            late_veg: { min: 0.8, max: 1.2 },
            flowering: { min: 1.2, max: 1.5 },
            dry: { min: 0.8, max: 1.2 }
        };

        // Chart configuration
        const chartColors = {
            temp: { border: '#f97316', bg: 'rgba(249, 115, 22, 0.1)' },
            humidity: { border: '#3b82f6', bg: 'rgba(59, 130, 246, 0.1)' },
            targetHumidity: { border: '#22c55e', bg: 'transparent' },
            vpd: { border: '#a855f7', bg: 'rgba(168, 85, 247, 0.1)' },
            outsideTemp: { border: '#fbbf24', bg: 'transparent' },
            outsideHumidity: { border: '#14b8a6', bg: 'transparent' }
        };

        const chartDefaults = {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        color: '#8fa396',
                        padding: 16,
                        font: { size: 12, family: 'Outfit' },
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    backgroundColor: '#151d19',
                    borderColor: '#243028',
                    borderWidth: 1,
                    titleColor: '#e8f0eb',
                    bodyColor: '#8fa396',
                    padding: 12,
                    titleFont: { size: 13, weight: 'bold', family: 'Outfit' },
                    bodyFont: { size: 12, family: 'JetBrains Mono' }
                }
            },
            scales: {
                x: {
                    grid: { color: 'rgba(36, 48, 40, 0.5)' },
                    ticks: { color: '#5a6b5f', font: { size: 11 }, maxRotation: 45 }
                },
                y: {
                    grid: { color: 'rgba(36, 48, 40, 0.5)' },
                    ticks: { color: '#5a6b5f', font: { size: 11, family: 'JetBrains Mono' } }
                }
            }
        };

        function initCharts() {
            // Temperature & Humidity Chart
            const ctx1 = document.getElementById('tempHumidityChart').getContext('2d');
            tempHumidityChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Temperatura (¬∞C)',
                            data: [],
                            borderColor: chartColors.temp.border,
                            backgroundColor: chartColors.temp.bg,
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y',
                            pointRadius: 0,
                            pointHoverRadius: 4
                        },
                        {
                            label: 'Humedad (%)',
                            data: [],
                            borderColor: chartColors.humidity.border,
                            backgroundColor: chartColors.humidity.bg,
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y1',
                            pointRadius: 0,
                            pointHoverRadius: 4
                        },
                        {
                            label: 'Humedad Objetivo (%)',
                            data: [],
                            borderColor: chartColors.targetHumidity.border,
                            backgroundColor: chartColors.targetHumidity.bg,
                            borderWidth: 2,
                            borderDash: [5, 5],
                            tension: 0.4,
                            fill: false,
                            yAxisID: 'y1',
                            pointRadius: 0,
                            pointHoverRadius: 4
                        }
                    ]
                },
                options: {
                    ...chartDefaults,
                    scales: {
                        ...chartDefaults.scales,
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            grid: { color: 'rgba(36, 48, 40, 0.5)' },
                            ticks: { color: chartColors.temp.border, font: { size: 11, family: 'JetBrains Mono' } },
                            title: { display: true, text: '¬∞C', color: chartColors.temp.border }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: { drawOnChartArea: false },
                            ticks: { color: chartColors.humidity.border, font: { size: 11, family: 'JetBrains Mono' } },
                            title: { display: true, text: '%', color: chartColors.humidity.border }
                        }
                    }
                }
            });

            // VPD Chart with optimal range band
            const ctx2 = document.getElementById('vpdChart').getContext('2d');
            vpdChart = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'VPD (kPa)',
                        data: [],
                        borderColor: chartColors.vpd.border,
                        backgroundColor: chartColors.vpd.bg,
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    ...chartDefaults,
                    plugins: {
                        ...chartDefaults.plugins,
                        annotation: {
                            annotations: {
                                optimalZone: {
                                    type: 'box',
                                    yMin: VPD_RANGES[currentStage].min,
                                    yMax: VPD_RANGES[currentStage].max,
                                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                                    borderColor: 'rgba(34, 197, 94, 0.3)',
                                    borderWidth: 1,
                                    label: {
                                        display: true,
                                        content: 'Rango √ìptimo',
                                        position: 'start',
                                        color: '#22c55e',
                                        font: { size: 10 }
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        ...chartDefaults.scales,
                        y: {
                            ...chartDefaults.scales.y,
                            min: 0,
                            max: 2.0,
                            title: { display: true, text: 'kPa', color: chartColors.vpd.border }
                        }
                    }
                }
            });

            // Comparison Chart
            const ctx3 = document.getElementById('comparisonChart').getContext('2d');
            comparisonChart = new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Temp. Interior (¬∞C)',
                            data: [],
                            borderColor: chartColors.temp.border,
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y',
                            pointRadius: 0,
                            pointHoverRadius: 4
                        },
                        {
                            label: 'Temp. Exterior (¬∞C)',
                            data: [],
                            borderColor: chartColors.outsideTemp.border,
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y',
                            pointRadius: 0,
                            pointHoverRadius: 4
                        },
                        {
                            label: 'Hum. Interior (%)',
                            data: [],
                            borderColor: chartColors.humidity.border,
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y1',
                            pointRadius: 0,
                            pointHoverRadius: 4
                        },
                        {
                            label: 'Hum. Exterior (%)',
                            data: [],
                            borderColor: chartColors.outsideHumidity.border,
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y1',
                            pointRadius: 0,
                            pointHoverRadius: 4
                        }
                    ]
                },
                options: {
                    ...chartDefaults,
                    scales: {
                        ...chartDefaults.scales,
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            grid: { color: 'rgba(36, 48, 40, 0.5)' },
                            ticks: { color: '#5a6b5f', font: { size: 11, family: 'JetBrains Mono' } },
                            title: { display: true, text: '¬∞C', color: '#5a6b5f' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: { drawOnChartArea: false },
                            ticks: { color: '#5a6b5f', font: { size: 11, family: 'JetBrains Mono' } },
                            title: { display: true, text: '%', color: '#5a6b5f' }
                        }
                    }
                }
            });
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            
            if (currentHours !== null && currentHours < 24) {
                return `${hours}:${minutes}`;
            } else if (currentInterval === 'daily') {
                return `${day}/${month}`;
            }
            return `${day}/${month} ${hours}:${minutes}`;
        }

        function updateVpdGauge(vpd) {
            const marker = document.getElementById('vpd-marker');
            if (!marker || vpd === null || vpd === undefined) return;
            
            // Scale VPD 0-2 to 0-100%
            const position = Math.min(Math.max((vpd / 2) * 100, 0), 100);
            marker.style.left = `${position}%`;
        }

        function updateHumidityBar(humidity, targetHumidity) {
            const fillEl = document.getElementById('humidity-bar-fill');
            const targetEl = document.getElementById('humidity-bar-target');
            const diffEl = document.getElementById('humidity-diff');
            
            if (fillEl && humidity !== null && humidity !== undefined) {
                fillEl.style.width = `${Math.min(Math.max(humidity, 0), 100)}%`;
            }
            
            if (targetEl && targetHumidity !== null && targetHumidity !== undefined) {
                targetEl.style.left = `${Math.min(Math.max(targetHumidity, 0), 100)}%`;
            }
            
            // Update difference indicator
            if (diffEl && humidity !== null && targetHumidity !== null) {
                const diff = humidity - targetHumidity;
                const absDiff = Math.abs(diff).toFixed(1);
                
                if (Math.abs(diff) <= 3) {
                    diffEl.className = 'humidity-diff on-target';
                    diffEl.innerHTML = '‚úì En objetivo';
                } else if (diff < 0) {
                    diffEl.className = 'humidity-diff too-low';
                    diffEl.innerHTML = `‚Üì ${absDiff}% por debajo`;
                } else {
                    diffEl.className = 'humidity-diff too-high';
                    diffEl.innerHTML = `‚Üë ${absDiff}% por encima`;
                }
            }
        }

        function updateCurrentData(data) {
            document.getElementById('current-temp').innerHTML = 
                (data.temperature?.toFixed(1) || '--') + '<span class="hero-unit">¬∞C</span>';
            document.getElementById('current-humidity').innerHTML = 
                (data.humidity?.toFixed(1) || '--') + '<span class="hero-unit">%</span>';
            document.getElementById('current-target-humidity').innerHTML = 
                (data.target_humidity ? data.target_humidity.toFixed(1) : '--') + '<span class="hero-unit">%</span>';
            document.getElementById('current-vpd').innerHTML = 
                (data.vpd?.toFixed(2) || '--') + '<span class="hero-unit">kPa</span>';
            document.getElementById('current-leaf-temp').textContent = 
                data.leaf_temperature ? data.leaf_temperature.toFixed(1) : '--';
            document.getElementById('current-outdoor-temp').innerHTML = 
                (data.outside_temperature?.toFixed(1) || '--') + '<span class="metric-unit">¬∞C</span>';
            document.getElementById('current-outdoor-humidity').innerHTML = 
                (data.outside_humidity?.toFixed(1) || '--') + '<span class="metric-unit">%</span>';
            
            // Update VPD gauge
            updateVpdGauge(data.vpd);
            
            // Update humidity bar
            updateHumidityBar(data.humidity, data.target_humidity);
            
            // Update VPD status
            const vpdCard = document.getElementById('vpd-card');
            const vpdStatus = document.getElementById('vpd-status');
            const vpdHint = document.getElementById('vpd-target-hint');
            
            const range = VPD_RANGES[currentStage];
            if (data.vpd_in_range === true) {
                vpdCard.classList.remove('vpd-adjusting');
                vpdCard.classList.add('vpd-optimal');
                vpdStatus.className = 'vpd-badge in-range';
                vpdStatus.innerHTML = '‚úì En rango √≥ptimo';
                vpdHint.textContent = `(${range.min}-${range.max} kPa)`;
            } else if (data.vpd_in_range === false) {
                vpdCard.classList.remove('vpd-optimal');
                vpdCard.classList.add('vpd-adjusting');
                vpdStatus.className = 'vpd-badge adjusting';
                vpdStatus.innerHTML = '‚ö° Ajustando...';
                vpdHint.textContent = `Objetivo: ${range.min}-${range.max} kPa`;
            } else {
                vpdCard.classList.remove('vpd-optimal', 'vpd-adjusting');
                vpdStatus.className = 'vpd-badge';
                vpdStatus.textContent = '';
                vpdHint.textContent = '';
            }
            
            document.getElementById('last-update').textContent = 
                `Actualizado: ${new Date().toLocaleString('es-AR')}`;
        }

        function updatePeriodSummary(data) {
            if (!data || data.sample_count === 0) return;
            
            // Temperature
            const tempAvg = data.temperature?.avg;
            document.getElementById('summary-temp-avg').innerHTML = 
                (tempAvg !== null ? tempAvg : '--') + '<span class="hero-unit">¬∞C</span>';
            document.getElementById('summary-temp-min').textContent = 
                (data.temperature?.min !== null ? data.temperature.min + '¬∞C' : '--¬∞C');
            document.getElementById('summary-temp-max').textContent = 
                (data.temperature?.max !== null ? data.temperature.max + '¬∞C' : '--¬∞C');
            
            // Humidity
            document.getElementById('summary-humidity-avg').innerHTML = 
                (data.humidity?.avg !== null ? data.humidity.avg : '--') + '<span class="hero-unit">%</span>';
            document.getElementById('summary-humidity-min').textContent = 
                (data.humidity?.min !== null ? data.humidity.min + '%' : '--%');
            document.getElementById('summary-humidity-max').textContent = 
                (data.humidity?.max !== null ? data.humidity.max + '%' : '--%');
            
            // VPD
            document.getElementById('summary-vpd-avg').innerHTML = 
                (data.vpd?.avg !== null ? data.vpd.avg : '--') + '<span class="hero-unit">kPa</span>';
            document.getElementById('summary-vpd-min').textContent = 
                (data.vpd?.min !== null ? data.vpd.min + ' kPa' : '-- kPa');
            document.getElementById('summary-vpd-max').textContent = 
                (data.vpd?.max !== null ? data.vpd.max + ' kPa' : '-- kPa');
            
            // Samples
            document.getElementById('summary-samples').textContent = 
                data.sample_count?.toLocaleString('es-AR') || '--';
            
            // Outside
            document.getElementById('summary-outside-temp').textContent = 
                (data.outside_temperature?.avg !== null ? data.outside_temperature.avg + '¬∞C' : '--¬∞C');
            document.getElementById('summary-outside-humidity').textContent = 
                (data.outside_humidity?.avg !== null ? data.outside_humidity.avg + '%' : '--%');
        }

        function updateSummaryPeriodLabel() {
            const label = document.getElementById('summary-period-label');
            if (currentHours !== null) {
                if (currentHours < 1) {
                    label.textContent = `√öltimos ${Math.round(currentHours * 60)} minutos`;
                } else {
                    label.textContent = `√öltimas ${currentHours}h`;
                }
            } else {
                label.textContent = `√öltimos ${currentPeriod} d√≠a${currentPeriod > 1 ? 's' : ''}`;
            }
        }

        function fetchPeriodSummary() {
            let url;
            if (currentHours !== null) {
                url = `/api/period-summary?hours=${currentHours}`;
            } else {
                url = `/api/period-summary?days=${currentPeriod}`;
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => updatePeriodSummary(data))
                .catch(error => console.error('Error fetching period summary:', error));
        }

        function updateDatabaseStats(stats) {
            if (stats.sensor_data_count) {
                document.getElementById('stat-records').textContent = 
                    stats.sensor_data_count.toLocaleString('es-AR');
            }
            if (stats.database_size_mb) {
                document.getElementById('stat-db-size').textContent = `${stats.database_size_mb} MB`;
            }
            if (stats.grow_count) {
                document.getElementById('stat-grows').textContent = stats.grow_count;
            }
            if (stats.oldest_record) {
                const date = new Date(stats.oldest_record);
                document.getElementById('stat-oldest').textContent = date.toLocaleDateString('es-AR');
            }
        }

        function updateActiveGrow(grow) {
            if (!grow) return;
            
            document.getElementById('grow-name').textContent = grow.name;
            currentStage = grow.stage;
            
            const stageElement = document.getElementById('grow-stage');
            const stageNames = {
                'early_veg': 'Vegetativo Temprano',
                'late_veg': 'Vegetativo Tard√≠o',
                'flowering': 'Floraci√≥n',
                'dry': 'Secado'
            };
            
            stageElement.textContent = stageNames[grow.stage] || grow.stage;
            stageElement.className = `grow-stage ${grow.stage}`;
            
            // Update VPD chart optimal zone
            if (vpdChart && VPD_RANGES[currentStage]) {
                const range = VPD_RANGES[currentStage];
                vpdChart.options.plugins.annotation.annotations.optimalZone.yMin = range.min;
                vpdChart.options.plugins.annotation.annotations.optimalZone.yMax = range.max;
                vpdChart.update();
            }
        }

        function updateHistoricalCharts(data) {
            if (!data || !data.data || data.data.length === 0) return;

            const sortedData = [...data.data].reverse();
            
            const labels = sortedData.map(d => formatDate(d.datetime));
            const temperatures = sortedData.map(d => d.temperature);
            const humidities = sortedData.map(d => d.humidity);
            const targetHumidities = sortedData.map(d => d.target_humidity || null);
            const vpds = sortedData.map(d => d.vpd);
            const outsideTemps = sortedData.map(d => d.outside_temperature);
            const outsideHumidities = sortedData.map(d => d.outside_humidity);

            // Update charts
            tempHumidityChart.data.labels = labels;
            tempHumidityChart.data.datasets[0].data = temperatures;
            tempHumidityChart.data.datasets[1].data = humidities;
            tempHumidityChart.data.datasets[2].data = targetHumidities;
            tempHumidityChart.update();

            vpdChart.data.labels = labels;
            vpdChart.data.datasets[0].data = vpds;
            vpdChart.update();

            comparisonChart.data.labels = labels;
            comparisonChart.data.datasets[0].data = temperatures;
            comparisonChart.data.datasets[1].data = outsideTemps;
            comparisonChart.data.datasets[2].data = humidities;
            comparisonChart.data.datasets[3].data = outsideHumidities;
            comparisonChart.update();
        }

        function updateSensorStatus(data) {
            const indoorEl = document.getElementById('sensor-status-indoor');
            const indoorEl2 = document.getElementById('sensor-status-indoor-2');
            const outdoorEl = document.getElementById('sensor-status-outdoor');
            const alertEl = document.getElementById('sensor-alert');
            const alertMsgEl = document.getElementById('sensor-alert-message');

            let errors = [];

            const updateBadge = (el, ok, error) => {
                if (!el) return;
                if (ok === true) {
                    el.textContent = '‚úÖ OK';
                    el.className = 'sensor-badge ok';
                } else if (ok === false) {
                    el.textContent = '‚ùå Error';
                    el.className = 'sensor-badge error';
                } else {
                    el.textContent = '‚è≥';
                    el.className = 'sensor-badge';
                }
            };

            if (data.indoor?.ok === true) {
                updateBadge(indoorEl, true);
                updateBadge(indoorEl2, true);
            } else if (data.indoor?.ok === false) {
                updateBadge(indoorEl, false);
                updateBadge(indoorEl2, false);
                errors.push('Interior: ' + (data.indoor.error || 'Error'));
            }

            if (data.outdoor?.ok === true) {
                updateBadge(outdoorEl, true);
            } else if (data.outdoor?.ok === false) {
                updateBadge(outdoorEl, false);
                errors.push('Exterior: ' + (data.outdoor.error || 'Error'));
            }

            if (alertEl && alertMsgEl) {
                if (errors.length > 0) {
                    alertMsgEl.textContent = errors.join(' ‚Ä¢ ');
                    alertEl.style.display = 'flex';
                } else {
                    alertEl.style.display = 'none';
                }
            }
        }

        function updateOutputsStatus(payload) {
            const grid = document.getElementById('outputs-grid');
            const outputs = payload?.outputs || [];

            if (!grid) return;

            if (!outputs.length) {
                grid.innerHTML = `
                    <div class="output-card">
                        <div class="output-name">No configuradas</div>
                        <div class="output-state unknown">--</div>
                    </div>
                `;
                return;
            }

            grid.innerHTML = outputs.map(o => {
                let stateText = '--';
                let stateClass = 'unknown';
                if (o.state === true) {
                    stateText = 'ENCENDIDA';
                    stateClass = 'on';
                } else if (o.state === false) {
                    stateText = 'APAGADA';
                    stateClass = 'off';
                }

                const label = o.label || o.name || 'Salida';
                const pin = (o.pin_bcm !== undefined && o.pin_bcm !== null) ? `BCM ${o.pin_bcm}` : '';
                
                return `
                    <div class="output-card">
                        <div class="output-header">
                            <div class="output-name">${label}</div>
                            <div class="output-pin">${pin}</div>
                        </div>
                        <div class="output-state ${stateClass}">${stateText}</div>
                    </div>
                `;
            }).join('');
        }

        // API Fetch functions
        function fetchCurrentData() {
            fetch('/api/current-data')
                .then(response => response.json())
                .then(data => updateCurrentData(data))
                .catch(error => console.error('Error fetching current data:', error));
        }

        function fetchOutputsStatus() {
            fetch('/api/output-status')
                .then(response => response.json())
                .then(payload => updateOutputsStatus(payload))
                .catch(error => console.error('Error fetching output status:', error));
        }

        function fetchSensorStatus() {
            fetch('/api/sensor-status')
                .then(response => response.json())
                .then(data => updateSensorStatus(data))
                .catch(error => console.error('Error fetching sensor status:', error));
        }

        function fetchDatabaseStats() {
            fetch('/api/database-stats')
                .then(response => response.json())
                .then(stats => updateDatabaseStats(stats))
                .catch(error => console.error('Error fetching database stats:', error));
        }

        function fetchHistoricalData(days, interval, hours = null) {
            let url;
            
            if (hours !== null) {
                const now = Math.floor(Date.now() / 1000);
                const start = now - (hours * 3600);
                url = `/api/sensor-history?start=${start}&end=${now}&limit=1000`;
            } else {
                url = `/api/history/aggregated?days=${days}&interval=${interval}`;
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (hours !== null) {
                        const adaptedData = { data: data.data || [], count: data.count || 0, aggregated: false };
                        updateHistoricalCharts(adaptedData);
                    } else {
                        updateHistoricalCharts(data);
                    }
                })
                .catch(error => console.error('Error fetching historical data:', error));
        }

        function fetchActiveGrow() {
            fetch('/api/grows/active')
                .then(response => response.json())
                .then(grow => updateActiveGrow(grow))
                .catch(error => console.error('Error fetching active grow:', error));
        }

        // Modal functions
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function showNewGrowModal() {
            document.getElementById('newGrowName').value = '';
            document.getElementById('newGrowStage').value = 'early_veg';
            document.getElementById('newGrowNotes').value = '';
            showModal('newGrowModal');
        }

        function showStageModal() {
            showModal('stageModal');
        }

        function showGrowModal() {
            showModal('growsModal');
            loadGrowsList();
        }

        // Grow management
        async function createGrow() {
            const name = document.getElementById('newGrowName').value.trim();
            const stage = document.getElementById('newGrowStage').value;
            const notes = document.getElementById('newGrowNotes').value.trim();

            if (!name) {
                alert('Por favor ingres√° un nombre para el cultivo');
                return;
            }

            try {
                const response = await fetch('/api/grows', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, stage, notes })
                });

                const result = await response.json();

                if (response.ok) {
                    alert(`‚úÖ ${result.message}`);
                    closeModal('newGrowModal');
                    fetchActiveGrow();
                    fetchDatabaseStats();
                    fetchHistoricalData(currentPeriod, currentInterval, currentHours);
                } else {
                    alert(`‚ùå Error: ${result.error}`);
                }
            } catch (error) {
                console.error('Error creating grow:', error);
                alert('‚ùå Error al crear el cultivo');
            }
        }

        async function updateStage() {
            const newStage = document.getElementById('newStage').value;

            try {
                const activeGrow = await fetch('/api/grows/active').then(r => r.json());
                
                const response = await fetch(`/api/grows/${activeGrow.id}/stage`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stage: newStage })
                });

                const result = await response.json();

                if (response.ok) {
                    alert(`‚úÖ ${result.message}`);
                    closeModal('stageModal');
                    fetchActiveGrow();
                } else {
                    alert(`‚ùå Error: ${result.error}`);
                }
            } catch (error) {
                console.error('Error updating stage:', error);
                alert('‚ùå Error al actualizar la etapa');
            }
        }

        async function activateGrow(growId) {
            if (!confirm('¬øQuer√©s activar este cultivo?')) return;

            try {
                const response = await fetch(`/api/grows/${growId}/activate`, { method: 'POST' });
                const result = await response.json();

                if (response.ok) {
                    alert(`‚úÖ ${result.message}`);
                    closeModal('growsModal');
                    fetchActiveGrow();
                    fetchDatabaseStats();
                    fetchHistoricalData(currentPeriod, currentInterval, currentHours);
                } else {
                    alert(`‚ùå Error: ${result.error}`);
                }
            } catch (error) {
                console.error('Error activating grow:', error);
                alert('‚ùå Error al activar el cultivo');
            }
        }

        async function endGrow(growId) {
            if (!confirm('¬øQuer√©s finalizar este cultivo?')) return;

            try {
                const response = await fetch(`/api/grows/${growId}/end`, { method: 'POST' });
                const result = await response.json();

                if (response.ok) {
                    alert(`‚úÖ ${result.message}`);
                    loadGrowsList();
                } else {
                    alert(`‚ùå Error: ${result.error}`);
                }
            } catch (error) {
                console.error('Error ending grow:', error);
                alert('‚ùå Error al finalizar el cultivo');
            }
        }

        async function loadGrowsList() {
            const growListElement = document.getElementById('growList');
            growListElement.innerHTML = '<div class="loading">Cargando cultivos</div>';

            try {
                const response = await fetch('/api/grows');
                const data = await response.json();

                if (data.grows && data.grows.length > 0) {
                    const stageNames = {
                        'early_veg': 'Vegetativo Temprano',
                        'late_veg': 'Vegetativo Tard√≠o',
                        'flowering': 'Floraci√≥n',
                        'dry': 'Secado'
                    };

                    growListElement.innerHTML = data.grows.map(grow => `
                        <div class="grow-item ${grow.is_active ? 'active' : ''}" onclick="${!grow.is_active ? `activateGrow(${grow.id})` : ''}">
                            <div class="grow-item-name">
                                ${grow.name}
                                ${grow.is_active ? '<span style="color: var(--accent-green);">‚úÖ ACTIVO</span>' : ''}
                            </div>
                            <span class="grow-stage ${grow.stage}">${stageNames[grow.stage] || grow.stage}</span>
                            <div class="grow-item-date">
                                Inicio: ${grow.start_date}<br>
                                ${grow.end_date ? `Fin: ${grow.end_date}` : ''}
                                ${grow.sample_count ? `‚Ä¢ ${grow.sample_count.toLocaleString('es-AR')} muestras` : ''}
                            </div>
                            ${!grow.end_date && !grow.is_active ? `
                                <button class="btn btn-ghost" style="margin-top: 10px; color: #ef4444; border-color: #ef4444;" onclick="event.stopPropagation(); endGrow(${grow.id})">
                                    Finalizar
                                </button>
                            ` : ''}
                        </div>
                    `).join('');
                } else {
                    growListElement.innerHTML = '<p style="text-align: center; color: var(--text-muted);">No hay cultivos registrados</p>';
                }
            } catch (error) {
                console.error('Error loading grows:', error);
                growListElement.innerHTML = '<p style="text-align: center; color: #ef4444;">Error al cargar cultivos</p>';
            }
        }

        // Time period selector - sync both selectors
        function handleTimeBtnClick(clickedBtn) {
            // Remove active from ALL time buttons (both selectors)
            document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
            
            // Find matching buttons in both selectors and activate them
            const hours = clickedBtn.dataset.hours;
            const period = clickedBtn.dataset.period;
            const interval = clickedBtn.dataset.interval;
            
            document.querySelectorAll('.time-btn').forEach(btn => {
                if (hours && btn.dataset.hours === hours) {
                    btn.classList.add('active');
                } else if (period && btn.dataset.period === period) {
                    btn.classList.add('active');
                }
            });
            
            if (hours) {
                currentHours = parseFloat(hours);
                currentPeriod = null;
                currentInterval = interval;
                fetchHistoricalData(null, null, currentHours);
            } else {
                currentHours = null;
                currentPeriod = parseInt(period);
                currentInterval = interval;
                fetchHistoricalData(currentPeriod, currentInterval);
            }
            
            updateSummaryPeriodLabel();
            fetchPeriodSummary();
        }

        document.querySelectorAll('.time-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                handleTimeBtnClick(this);
            });
        });

        // Initialize
        window.addEventListener('load', function() {
            initCharts();
            fetchCurrentData();
            fetchOutputsStatus();
            fetchSensorStatus();
            fetchDatabaseStats();
            fetchActiveGrow();
            fetchHistoricalData(currentPeriod, currentInterval, currentHours);
            fetchPeriodSummary();
            updateSummaryPeriodLabel();
            
            // Update intervals
            setInterval(fetchCurrentData, 3000);
            setInterval(fetchOutputsStatus, 3000);
            setInterval(fetchSensorStatus, 30000);
            setInterval(() => {
                fetchHistoricalData(currentPeriod, currentInterval, currentHours);
                fetchPeriodSummary();
            }, 30000);
            setInterval(fetchDatabaseStats, 60000);
            setInterval(fetchActiveGrow, 60000);
        });

        // Close modal on outside click
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('show');
            }
        });
    </script>
</body>
</html>
