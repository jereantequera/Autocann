<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autocann Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }
        
        .last-update {
            color: #7f8c8d;
            font-size: 0.95em;
        }
        
        .db-stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .db-stat {
            background: #f8f9fa;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9em;
        }
        
        .db-stat-label {
            color: #7f8c8d;
            font-size: 0.85em;
        }
        
        .db-stat-value {
            color: #2c3e50;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .section-title {
            color: white;
            margin: 30px 0 20px 0;
            padding-left: 15px;
            border-left: 5px solid rgba(255,255,255,0.5);
            font-size: 1.8em;
        }
        
        .current-data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 50px rgba(0,0,0,0.15);
        }
        
        .metric-label {
            color: #7f8c8d;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        
        .metric-value {
            font-size: 3em;
            font-weight: bold;
            color: #2c3e50;
            margin: 10px 0;
        }
        
        .metric-unit {
            color: #95a5a6;
            font-size: 1.2em;
        }
        
        .metric-card.outdoor {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .metric-card.outdoor .metric-label,
        .metric-card.outdoor .metric-unit {
            color: rgba(255,255,255,0.8);
        }
        
        .metric-card.outdoor .metric-value {
            color: white;
        }

        /* Outputs / Relays */
        .metric-card.output-card .metric-value {
            font-size: 1.8em;
        }

        .output-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .output-meta {
            color: #95a5a6;
            font-size: 0.9em;
            margin-top: 6px;
        }

        /* (Switch removed) Outputs are read-only now */

        .output-state-on {
            color: #27ae60;
        }

        .output-state-off {
            color: #e74c3c;
        }

        .output-state-unknown {
            color: #7f8c8d;
        }

        /* Sensor status indicator */
        .sensor-status {
            display: inline-block;
            font-size: 0.6em;
            margin-left: 10px;
            padding: 4px 10px;
            border-radius: 12px;
            vertical-align: middle;
            cursor: help;
        }

        .sensor-status.ok {
            background: rgba(39, 174, 96, 0.2);
        }

        .sensor-status.error {
            background: rgba(231, 76, 60, 0.3);
        }

        .sensor-status.unknown {
            background: rgba(127, 140, 141, 0.2);
        }
        
        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .chart-title {
            font-size: 1.5em;
            color: #2c3e50;
            font-weight: bold;
        }
        
        .time-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .time-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 0.95em;
        }
        
        .time-btn:hover {
            background: #f8f9fa;
        }
        
        .time-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }
        
        .chart-wrapper {
            position: relative;
            height: 400px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-size: 1.1em;
        }
        
        .loading::after {
            content: '...';
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        .stat-title {
            color: #7f8c8d;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
        }
        
        /* Grow Management Styles */
        .grow-control {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .grow-info {
            flex: 1;
            min-width: 250px;
        }
        
        .grow-name {
            font-size: 1.5em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .grow-stage {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            text-transform: uppercase;
            margin-top: 5px;
        }
        
        .grow-stage.early_veg {
            background: #d4edda;
            color: #155724;
        }
        
        .grow-stage.late_veg {
            background: #cce5ff;
            color: #004085;
        }
        
        .grow-stage.flowering {
            background: #f8d7da;
            color: #721c24;
        }
        
        .grow-stage.dry {
            background: #fff3cd;
            color: #856404;
        }
        
        .grow-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #229954;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            font-size: 1.8em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }
        
        select.form-control {
            cursor: pointer;
        }
        
        textarea.form-control {
            resize: vertical;
            min-height: 80px;
        }
        
        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }
        
        .grow-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .grow-item {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .grow-item:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }
        
        .grow-item.active {
            border-color: #27ae60;
            background: #d4edda;
        }
        
        .grow-item-name {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        
        .grow-item-date {
            font-size: 0.85em;
            color: #7f8c8d;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .chart-wrapper {
                height: 300px;
            }
            
            .metric-value {
                font-size: 2em;
            }
            
            .grow-control {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .grow-actions {
                width: 100%;
            }
            
            .btn {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üåø Autocann Dashboard</h1>
            <div class="header-info">
                <div class="last-update" id="last-update">Cargando...</div>
                <div class="db-stats" id="db-stats">
                    <div class="db-stat">
                        <div class="db-stat-label">Registros</div>
                        <div class="db-stat-value" id="stat-records">--</div>
                    </div>
                    <div class="db-stat">
                        <div class="db-stat-label">Base de Datos</div>
                        <div class="db-stat-value" id="stat-db-size">--</div>
                    </div>
                    <div class="db-stat">
                        <div class="db-stat-label">Cultivos</div>
                        <div class="db-stat-value" id="stat-grows">--</div>
                    </div>
                    <div class="db-stat">
                        <div class="db-stat-label">Desde</div>
                        <div class="db-stat-value" id="stat-oldest">--</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Grow Control -->
        <div class="grow-control">
            <div class="grow-info">
                <div class="grow-name" id="grow-name">Cargando...</div>
                <div>
                    <span class="grow-stage" id="grow-stage">--</span>
                </div>
            </div>
            <div class="grow-actions">
                <button class="btn btn-primary" onclick="showGrowModal()">üìã Ver Cultivos</button>
                <button class="btn btn-success" onclick="showNewGrowModal()">‚ûï Nuevo Cultivo</button>
                <button class="btn btn-secondary" onclick="showStageModal()">üîÑ Cambiar Etapa</button>
            </div>
        </div>

        <!-- Outputs / Relays -->
        <h2 class="section-title">üîå Salidas (Relays)</h2>
        <div class="last-update" style="margin: -10px 0 15px 15px;">
            Nota: si est√° corriendo el control autom√°tico (fix-vpd), puede volver a cambiar las salidas.
        </div>
        <div class="current-data-grid" id="outputs-grid">
            <div class="metric-card output-card">
                <div class="metric-label">Cargando salidas...</div>
                <div class="metric-value output-state-unknown">--</div>
                <div class="metric-unit">Estado</div>
            </div>
        </div>

        <!-- Current Indoor Data -->
        <h2 class="section-title">
            üìä Datos Actuales - Interior
            <span class="sensor-status" id="sensor-status-indoor" title="Estado del sensor interior">‚è≥</span>
        </h2>
        <div class="current-data-grid">
            <div class="metric-card">
                <div class="metric-label">Temperatura</div>
                <div class="metric-value" id="current-temp">--</div>
                <div class="metric-unit">¬∞C</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Humedad</div>
                <div class="metric-value" id="current-humidity">--</div>
                <div class="metric-unit">%</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Humedad Objetivo</div>
                <div class="metric-value" id="current-target-humidity">--</div>
                <div class="metric-unit">%</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">VPD</div>
                <div class="metric-value" id="current-vpd">--</div>
                <div class="metric-unit">kPa</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Temp. Hoja</div>
                <div class="metric-value" id="current-leaf-temp">--</div>
                <div class="metric-unit">¬∞C</div>
            </div>
        </div>

        <!-- Current Outdoor Data -->
        <h2 class="section-title">
            üå§Ô∏è Datos Actuales - Exterior
            <span class="sensor-status" id="sensor-status-outdoor" title="Estado del sensor exterior">‚è≥</span>
        </h2>
        <div class="current-data-grid">
            <div class="metric-card outdoor">
                <div class="metric-label">Temperatura Exterior</div>
                <div class="metric-value" id="current-outdoor-temp">--</div>
                <div class="metric-unit">¬∞C</div>
            </div>
            <div class="metric-card outdoor">
                <div class="metric-label">Humedad Exterior</div>
                <div class="metric-value" id="current-outdoor-humidity">--</div>
                <div class="metric-unit">%</div>
            </div>
        </div>

        <!-- Historical Charts -->
        <h2 class="section-title">üìà Gr√°ficos Hist√≥ricos</h2>
        
        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-title">Temperatura y Humedad</div>
                <div class="time-selector">
                    <button class="time-btn" data-hours="0.5" data-interval="raw">30 min</button>
                    <button class="time-btn" data-hours="1" data-interval="raw">1 Hora</button>
                    <button class="time-btn" data-hours="3" data-interval="raw">3 Horas</button>
                    <button class="time-btn" data-hours="6" data-interval="raw">6 Horas</button>
                    <button class="time-btn" data-hours="12" data-interval="raw">12 Horas</button>
                    <button class="time-btn active" data-period="1" data-interval="hourly">1 D√≠a</button>
                    <button class="time-btn" data-period="7" data-interval="hourly">7 D√≠as</button>
                    <button class="time-btn" data-period="30" data-interval="6hourly">30 D√≠as</button>
                    <button class="time-btn" data-period="90" data-interval="daily">90 D√≠as</button>
                </div>
            </div>
            <div class="chart-wrapper">
                <canvas id="tempHumidityChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-title">VPD (Vapor Pressure Deficit)</div>
            </div>
            <div class="chart-wrapper">
                <canvas id="vpdChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-title">Comparaci√≥n Interior vs Exterior</div>
            </div>
            <div class="chart-wrapper">
                <canvas id="comparisonChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- New Grow Modal -->
    <div id="newGrowModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Crear Nuevo Cultivo</div>
            <div class="form-group">
                <label class="form-label">Nombre del Cultivo</label>
                <input type="text" id="newGrowName" class="form-control" placeholder="Ej: Cultivo #2 - OG Kush">
            </div>
            <div class="form-group">
                <label class="form-label">Etapa Inicial</label>
                <select id="newGrowStage" class="form-control">
                    <option value="early_veg">Vegetativo Temprano</option>
                    <option value="late_veg">Vegetativo Tard√≠o</option>
                    <option value="flowering">Floraci√≥n</option>
                    <option value="dry">Secado</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Notas (opcional)</label>
                <textarea id="newGrowNotes" class="form-control" placeholder="Ej: Semillas feminizadas, ..."></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('newGrowModal')">Cancelar</button>
                <button class="btn btn-success" onclick="createGrow()">Crear Cultivo</button>
            </div>
        </div>
    </div>

    <!-- Change Stage Modal -->
    <div id="stageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Cambiar Etapa del Cultivo</div>
            <div class="form-group">
                <label class="form-label">Nueva Etapa</label>
                <select id="newStage" class="form-control">
                    <option value="early_veg">Vegetativo Temprano</option>
                    <option value="late_veg">Vegetativo Tard√≠o</option>
                    <option value="flowering">Floraci√≥n</option>
                    <option value="dry">Secado</option>
                </select>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('stageModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="updateStage()">Actualizar Etapa</button>
            </div>
        </div>
    </div>

    <!-- Grows List Modal -->
    <div id="growsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Todos los Cultivos</div>
            <div class="grow-list" id="growList">
                <div class="loading">Cargando cultivos...</div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('growsModal')">Cerrar</button>
            </div>
        </div>
    </div>

    <script>
        // Chart configurations
        const chartConfig = {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        padding: 20,
                        font: {
                            size: 13,
                            weight: 'bold'
                        }
                    }
                },
                tooltip: {
                    enabled: true,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: {
                        size: 14,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 13
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        maxRotation: 45,
                        minRotation: 0
                    }
                },
                y: {
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                }
            }
        };

        // Initialize charts
        let tempHumidityChart, vpdChart, comparisonChart;
        let currentPeriod = 1;
        let currentInterval = 'hourly';
        let currentHours = null;  // For sub-day periods

        function initCharts() {
            // Temperature & Humidity Chart
            const ctx1 = document.getElementById('tempHumidityChart').getContext('2d');
            tempHumidityChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Temperatura (¬∞C)',
                            data: [],
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Humedad (%)',
                            data: [],
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y1'
                        },
                        {
                            label: 'Humedad Objetivo (%)',
                            data: [],
                            borderColor: '#2ecc71',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            tension: 0.4,
                            fill: false,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    ...chartConfig,
                    scales: {
                        ...chartConfig.scales,
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Temperatura (¬∞C)',
                                font: {
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(231, 76, 60, 0.1)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Humedad (%)',
                                font: {
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                drawOnChartArea: false,
                            }
                        }
                    }
                }
            });

            // VPD Chart
            const ctx2 = document.getElementById('vpdChart').getContext('2d');
            vpdChart = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'VPD (kPa)',
                        data: [],
                        borderColor: '#9b59b6',
                        backgroundColor: 'rgba(155, 89, 182, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    ...chartConfig,
                    scales: {
                        ...chartConfig.scales,
                        y: {
                            ...chartConfig.scales.y,
                            title: {
                                display: true,
                                text: 'VPD (kPa)',
                                font: {
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                }
            });

            // Comparison Chart
            const ctx3 = document.getElementById('comparisonChart').getContext('2d');
            comparisonChart = new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Temperatura Interior (¬∞C)',
                            data: [],
                            borderColor: '#e74c3c',
                            backgroundColor: 'transparent',
                            borderWidth: 3,
                            tension: 0.4
                        },
                        {
                            label: 'Temperatura Exterior (¬∞C)',
                            data: [],
                            borderColor: '#f39c12',
                            backgroundColor: 'transparent',
                            borderWidth: 3,
                            tension: 0.4
                        },
                        {
                            label: 'Humedad Interior (%)',
                            data: [],
                            borderColor: '#3498db',
                            backgroundColor: 'transparent',
                            borderWidth: 3,
                            tension: 0.4,
                            yAxisID: 'y1'
                        },
                        {
                            label: 'Humedad Exterior (%)',
                            data: [],
                            borderColor: '#1abc9c',
                            backgroundColor: 'transparent',
                            borderWidth: 3,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    ...chartConfig,
                    scales: {
                        ...chartConfig.scales,
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Temperatura (¬∞C)',
                                font: {
                                    weight: 'bold'
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Humedad (%)',
                                font: {
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                drawOnChartArea: false,
                            }
                        }
                    }
                }
            });
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            
            // For sub-day periods, show hours:minutes only
            if (currentHours !== null && currentHours < 24) {
                return `${hours}:${minutes}`;
            } else if (currentInterval === 'daily') {
                return `${day}/${month}`;
            } else {
                return `${day}/${month} ${hours}:${minutes}`;
            }
        }

        function updateCurrentData(data) {
            document.getElementById('current-temp').textContent = data.temperature?.toFixed(1) || '--';
            document.getElementById('current-humidity').textContent = data.humidity?.toFixed(1) || '--';
            document.getElementById('current-target-humidity').textContent = 
                data.target_humidity ? data.target_humidity.toFixed(1) : '--';
            document.getElementById('current-vpd').textContent = data.vpd?.toFixed(2) || '--';
            document.getElementById('current-leaf-temp').textContent = 
                data.leaf_temperature ? data.leaf_temperature.toFixed(1) : '--';
            document.getElementById('current-outdoor-temp').textContent = 
                data.outside_temperature?.toFixed(1) || '--';
            document.getElementById('current-outdoor-humidity').textContent = 
                data.outside_humidity?.toFixed(1) || '--';
            
            document.getElementById('last-update').textContent = 
                `√öltima actualizaci√≥n: ${new Date().toLocaleString('es-AR')}`;
        }

        function updateDatabaseStats(stats) {
            if (stats.sensor_data_count) {
                document.getElementById('stat-records').textContent = 
                    stats.sensor_data_count.toLocaleString('es-AR');
            }
            if (stats.database_size_mb) {
                document.getElementById('stat-db-size').textContent = 
                    `${stats.database_size_mb} MB`;
            }
            if (stats.grow_count) {
                document.getElementById('stat-grows').textContent = stats.grow_count;
            }
            if (stats.oldest_record) {
                const date = new Date(stats.oldest_record);
                document.getElementById('stat-oldest').textContent = 
                    date.toLocaleDateString('es-AR');
            }
        }

        function updateActiveGrow(grow) {
            if (!grow) return;
            
            document.getElementById('grow-name').textContent = grow.name;
            
            const stageElement = document.getElementById('grow-stage');
            const stageNames = {
                'early_veg': 'Vegetativo Temprano',
                'late_veg': 'Vegetativo Tard√≠o',
                'flowering': 'Floraci√≥n',
                'dry': 'Secado'
            };
            
            stageElement.textContent = stageNames[grow.stage] || grow.stage;
            stageElement.className = `grow-stage ${grow.stage}`;
        }

        function updateHistoricalCharts(data) {
            if (!data || !data.data || data.data.length === 0) {
                console.log('No historical data available');
                return;
            }

            // Reverse data to show oldest to newest
            const sortedData = [...data.data].reverse();
            
            const labels = sortedData.map(d => formatDate(d.datetime));
            const temperatures = sortedData.map(d => d.temperature);
            const humidities = sortedData.map(d => d.humidity);
            const targetHumidities = sortedData.map(d => d.target_humidity || null);
            const vpds = sortedData.map(d => d.vpd);
            const outsideTemps = sortedData.map(d => d.outside_temperature);
            const outsideHumidities = sortedData.map(d => d.outside_humidity);

            // Update Temperature & Humidity Chart
            tempHumidityChart.data.labels = labels;
            tempHumidityChart.data.datasets[0].data = temperatures;
            tempHumidityChart.data.datasets[1].data = humidities;
            tempHumidityChart.data.datasets[2].data = targetHumidities;
            tempHumidityChart.update();

            // Update VPD Chart
            vpdChart.data.labels = labels;
            vpdChart.data.datasets[0].data = vpds;
            vpdChart.update();

            // Update Comparison Chart
            comparisonChart.data.labels = labels;
            comparisonChart.data.datasets[0].data = temperatures;
            comparisonChart.data.datasets[1].data = outsideTemps;
            comparisonChart.data.datasets[2].data = humidities;
            comparisonChart.data.datasets[3].data = outsideHumidities;
            comparisonChart.update();
        }

        function fetchCurrentData() {
            fetch('/api/current-data')
                .then(response => response.json())
                .then(data => updateCurrentData(data))
                .catch(error => console.error('Error fetching current data:', error));
        }

        function updateOutputsStatus(payload) {
            const grid = document.getElementById('outputs-grid');
            const outputs = payload?.outputs || [];

            if (!grid) return;

            if (!outputs.length) {
                grid.innerHTML = `
                    <div class="metric-card output-card">
                        <div class="metric-label">Salidas</div>
                        <div class="metric-value output-state-unknown">No configuradas</div>
                        <div class="metric-unit">Estado</div>
                    </div>
                `;
                return;
            }

            grid.innerHTML = outputs.map(o => {
                let stateText = '--';
                let stateClass = 'output-state-unknown';
                if (o.state === true) {
                    stateText = 'PRENDIDA';
                    stateClass = 'output-state-on';
                } else if (o.state === false) {
                    stateText = 'APAGADA';
                    stateClass = 'output-state-off';
                }

                const label = o.label || o.name || 'Salida';
                const pin = (o.pin_bcm !== undefined && o.pin_bcm !== null) ? `BCM ${o.pin_bcm}` : 'BCM --';
                return `
                    <div class="metric-card output-card">
                        <div class="output-card-header">
                            <div>
                                <div class="metric-label">${label}</div>
                                <div class="output-meta">${pin}</div>
                            </div>
                        </div>
                        <div class="metric-value ${stateClass}">${stateText}</div>
                        <div class="metric-unit">Estado</div>
                    </div>
                `;
            }).join('');
        }

        function fetchOutputsStatus() {
            fetch('/api/output-status')
                .then(response => response.json())
                .then(payload => updateOutputsStatus(payload))
                .catch(error => console.error('Error fetching output status:', error));
        }

        function updateSensorStatus(data) {
            const indoorEl = document.getElementById('sensor-status-indoor');
            const outdoorEl = document.getElementById('sensor-status-outdoor');

            if (indoorEl) {
                if (data.indoor?.ok === true) {
                    indoorEl.textContent = '‚úÖ Sensor OK';
                    indoorEl.className = 'sensor-status ok';
                    indoorEl.title = 'Sensor interior conectado y funcionando';
                } else if (data.indoor?.ok === false) {
                    indoorEl.textContent = '‚ùå ' + (data.indoor.error || 'Error');
                    indoorEl.className = 'sensor-status error';
                    indoorEl.title = 'Error: ' + (data.indoor.error || 'Sensor no disponible');
                } else {
                    indoorEl.textContent = '‚è≥ Desconocido';
                    indoorEl.className = 'sensor-status unknown';
                    indoorEl.title = 'Estado del sensor desconocido';
                }
            }

            if (outdoorEl) {
                if (data.outdoor?.ok === true) {
                    outdoorEl.textContent = '‚úÖ Sensor OK';
                    outdoorEl.className = 'sensor-status ok';
                    outdoorEl.title = 'Sensor exterior conectado y funcionando';
                } else if (data.outdoor?.ok === false) {
                    outdoorEl.textContent = '‚ùå ' + (data.outdoor.error || 'Error');
                    outdoorEl.className = 'sensor-status error';
                    outdoorEl.title = 'Error: ' + (data.outdoor.error || 'Sensor no disponible');
                } else {
                    outdoorEl.textContent = '‚è≥ Desconocido';
                    outdoorEl.className = 'sensor-status unknown';
                    outdoorEl.title = 'Estado del sensor desconocido';
                }
            }
        }

        function fetchSensorStatus() {
            fetch('/api/sensor-status')
                .then(response => response.json())
                .then(data => updateSensorStatus(data))
                .catch(error => console.error('Error fetching sensor status:', error));
        }

        // Output toggles removed (read-only dashboard)

        function fetchDatabaseStats() {
            fetch('/api/database-stats')
                .then(response => response.json())
                .then(stats => updateDatabaseStats(stats))
                .catch(error => console.error('Error fetching database stats:', error));
        }

        function fetchHistoricalData(days, interval, hours = null) {
            let url;
            
            if (hours !== null) {
                // For sub-day periods, use sensor-history endpoint (raw data)
                const now = Math.floor(Date.now() / 1000);
                const start = now - (hours * 3600);
                url = `/api/sensor-history?start=${start}&end=${now}&limit=1000`;
            } else {
                // For multi-day periods, use aggregated endpoint
                url = `/api/history/aggregated?days=${days}&interval=${interval}`;
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    // Adapt response format if using sensor-history
                    if (hours !== null) {
                        const adaptedData = {
                            data: data.data || [],
                            count: data.count || 0,
                            aggregated: false
                        };
                        updateHistoricalCharts(adaptedData);
                    } else {
                        updateHistoricalCharts(data);
                    }
                })
                .catch(error => console.error('Error fetching historical data:', error));
        }

        function fetchActiveGrow() {
            fetch('/api/grows/active')
                .then(response => response.json())
                .then(grow => updateActiveGrow(grow))
                .catch(error => console.error('Error fetching active grow:', error));
        }

        // Modal Functions
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function showNewGrowModal() {
            document.getElementById('newGrowName').value = '';
            document.getElementById('newGrowStage').value = 'early_veg';
            document.getElementById('newGrowNotes').value = '';
            showModal('newGrowModal');
        }

        function showStageModal() {
            showModal('stageModal');
        }

        function showGrowModal() {
            showModal('growsModal');
            loadGrowsList();
        }

        // Grow Management Functions
        async function createGrow() {
            const name = document.getElementById('newGrowName').value.trim();
            const stage = document.getElementById('newGrowStage').value;
            const notes = document.getElementById('newGrowNotes').value.trim();

            if (!name) {
                alert('Por favor ingres√° un nombre para el cultivo');
                return;
            }

            try {
                const response = await fetch('/api/grows', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name, stage, notes })
                });

                const result = await response.json();

                if (response.ok) {
                    alert(`‚úÖ ${result.message}`);
                    closeModal('newGrowModal');
                    fetchActiveGrow();
                    fetchDatabaseStats();
                    fetchHistoricalData(currentPeriod, currentInterval, currentHours);
                } else {
                    alert(`‚ùå Error: ${result.error}`);
                }
            } catch (error) {
                console.error('Error creating grow:', error);
                alert('‚ùå Error al crear el cultivo');
            }
        }

        async function updateStage() {
            const newStage = document.getElementById('newStage').value;

            try {
                const activeGrow = await fetch('/api/grows/active').then(r => r.json());
                
                const response = await fetch(`/api/grows/${activeGrow.id}/stage`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ stage: newStage })
                });

                const result = await response.json();

                if (response.ok) {
                    alert(`‚úÖ ${result.message}`);
                    closeModal('stageModal');
                    fetchActiveGrow();
                } else {
                    alert(`‚ùå Error: ${result.error}`);
                }
            } catch (error) {
                console.error('Error updating stage:', error);
                alert('‚ùå Error al actualizar la etapa');
            }
        }

        async function activateGrow(growId) {
            if (!confirm('¬øQuer√©s activar este cultivo? Se desactivar√° el cultivo actual.')) {
                return;
            }

            try {
                const response = await fetch(`/api/grows/${growId}/activate`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (response.ok) {
                    alert(`‚úÖ ${result.message}`);
                    closeModal('growsModal');
                    fetchActiveGrow();
                    fetchDatabaseStats();
                    fetchHistoricalData(currentPeriod, currentInterval, currentHours);
                } else {
                    alert(`‚ùå Error: ${result.error}`);
                }
            } catch (error) {
                console.error('Error activating grow:', error);
                alert('‚ùå Error al activar el cultivo');
            }
        }

        async function endGrow(growId) {
            if (!confirm('¬øQuer√©s finalizar este cultivo? No podr√° reactivarse.')) {
                return;
            }

            try {
                const response = await fetch(`/api/grows/${growId}/end`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (response.ok) {
                    alert(`‚úÖ ${result.message}`);
                    loadGrowsList();
                } else {
                    alert(`‚ùå Error: ${result.error}`);
                }
            } catch (error) {
                console.error('Error ending grow:', error);
                alert('‚ùå Error al finalizar el cultivo');
            }
        }

        async function loadGrowsList() {
            const growListElement = document.getElementById('growList');
            growListElement.innerHTML = '<div class="loading">Cargando cultivos...</div>';

            try {
                const response = await fetch('/api/grows');
                const data = await response.json();

                if (data.grows && data.grows.length > 0) {
                    const stageNames = {
                        'early_veg': 'Vegetativo Temprano',
                        'late_veg': 'Vegetativo Tard√≠o',
                        'flowering': 'Floraci√≥n',
                        'dry': 'Secado'
                    };

                    growListElement.innerHTML = data.grows.map(grow => `
                        <div class="grow-item ${grow.is_active ? 'active' : ''}" onclick="${!grow.is_active ? `activateGrow(${grow.id})` : ''}">
                            <div class="grow-item-name">
                                ${grow.name}
                                ${grow.is_active ? '‚úÖ ACTIVO' : ''}
                            </div>
                            <div>
                                <span class="grow-stage ${grow.stage}">${stageNames[grow.stage] || grow.stage}</span>
                            </div>
                            <div class="grow-item-date">
                                Inicio: ${grow.start_date}<br>
                                ${grow.end_date ? `Fin: ${grow.end_date}` : ''}
                                ${grow.sample_count ? `Muestras: ${grow.sample_count.toLocaleString('es-AR')}` : ''}
                            </div>
                            ${!grow.end_date && !grow.is_active ? `
                                <button class="btn btn-danger" style="margin-top: 10px;" onclick="event.stopPropagation(); endGrow(${grow.id})">
                                    Finalizar Cultivo
                                </button>
                            ` : ''}
                        </div>
                    `).join('');
                } else {
                    growListElement.innerHTML = '<p style="text-align: center; color: #7f8c8d;">No hay cultivos registrados</p>';
                }
            } catch (error) {
                console.error('Error loading grows:', error);
                growListElement.innerHTML = '<p style="text-align: center; color: #e74c3c;">Error al cargar cultivos</p>';
            }
        }

        // Time period selector
        document.querySelectorAll('.time-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                // Check if it's an hourly period (sub-day)
                if (this.dataset.hours) {
                    currentHours = parseFloat(this.dataset.hours);
                    currentPeriod = null;
                    currentInterval = this.dataset.interval;
                    fetchHistoricalData(null, null, currentHours);
                } else {
                    currentHours = null;
                    currentPeriod = parseInt(this.dataset.period);
                    currentInterval = this.dataset.interval;
                    fetchHistoricalData(currentPeriod, currentInterval);
                }
            });
        });

        // Initialize
        window.addEventListener('load', function() {
            initCharts();
            fetchCurrentData();
            fetchOutputsStatus();
            fetchSensorStatus();
            fetchDatabaseStats();
            fetchActiveGrow();
            fetchHistoricalData(currentPeriod, currentInterval, currentHours);
            
            // Update current data every 3 seconds
            setInterval(fetchCurrentData, 3000);
            setInterval(fetchOutputsStatus, 3000);
            
            // Update sensor status every 30 seconds
            setInterval(fetchSensorStatus, 30000);
            
            // Update historical data every 30 seconds
            setInterval(() => {
                fetchHistoricalData(currentPeriod, currentInterval, currentHours);
            }, 30000);
            
            // Update database stats every 60 seconds
            setInterval(fetchDatabaseStats, 60000);
            
            // Update active grow every 60 seconds
            setInterval(fetchActiveGrow, 60000);
        });

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('show');
            }
        });
    </script>
</body>
</html>
